"use strict";function toggleArranger(e){"false"!=mgArranger.getAttribute("data-open")?mgArranger.setAttribute("data-open","false"):mgArranger.setAttribute("data-open","true")}function getArrangerSettings(){return{filtering:{genre:getArrangerCheckbox(),rating:sliderRating.noUiSlider.get(),runtime:parseData(sliderRuntime.noUiSlider.get()),year:parseData(sliderYear.noUiSlider.get())},sorting:{sortingby:getArrangerRadiobuttons(),sortingorder:getArrangerSortingorder()}}}function parseData(e){var t=[];for(var r in e)t.push(parseInt(e[r]));return t}function getArrangerCheckbox(){for(var e=[],t=0;t<mgFilteringGenre.length;t++)1==mgFilteringGenre[t].checked&&e.push(mgFilteringGenre[t].value);return e}function getArrangerRadiobuttons(){for(var e=0;e<mgRadioInput.length;e++)if(1==mgRadioInput[e].checked)return mgRadioInput[e].value}function getArrangerSortingorder(){return mgSortingOrder[0].checked?mgSortingOrder[0].value:mgSortingOrder[1].value}function compareArranger(){var e=getArrangerSettings();if(compareSettings(e,"filtering")){console.log("--------------------------------------------"),console.log("UPDATE DOM - with new filter"),window.lastSettings=e;var t={task:"discover",settings:lastSettings};return toggleArranger(),void loadController(t,"reset-movies")}if(compareSettings(e,"sorting")){console.log("UPDATE DOM - with new positioning"),window.lastSettings=e,toggleArranger();var r=sortingMovies(e.sorting.sortingby,e.sorting.sortingorder);return clearMovieElements(),void addMovieElements(r)}console.log("No changes found"),toggleArranger()}function compareSettings(e,t){return JSON.stringify(lastSettings[t])!==JSON.stringify(e[t])}function sortingMovies(e,t){function r(e,t,r){var o=void 0;return"word"==e&&(o=n.sort(sortingWords(t,r))),"number"==e&&(o=n.sort(sortingNumbers(t,r))),o}var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:movieAPI.getMovieArr();if(n)return console.log("Sorting by "+e),"rating"==e?r("number","vote_average",t):"popularity"==e?r("number","popularity",t):"year"==e?r("number","release_date",t):"title"==e?r("word","title",t):void 0}function sortingNumbers(e,t){return function(r,n){return"lowest"==t?parseFloat(r[e])-parseFloat(n[e]):"highest"==t?parseFloat(n[e])-parseFloat(r[e]):void 0}}function sortingWords(e,t){return function(r,n){var o=r[e].toUpperCase(),i=n[e].toUpperCase();if("lowest"==t){if(o<i)return-1;if(o>i)return 1}if("highest"==t){if(o>i)return-1;if(o<i)return 1}return 0}}function loadMovies(e){return console.log("Loading movies"),Promise.resolve(fetchTMDb(e))}function loadController(e,t){"reset-movies"==t&&(console.log("Resetting movies!"),movieAPI.clearMovies(),clearMovieElements(),resetMonitor()),monitorMovieElements.total_pages==monitorMovieElements.current_page&&monitorMovieElements.fetched?console.log("All movies loaded!"):loadMovies(e).then(function(e){var t=sortingMovies(lastSettings.sorting.sortingby,lastSettings.sorting.sortingorder,e.results);return movieAPI.setMovie(t),movieAPI.setMovieIndex(),monitorMovieElements.total_pages=e.total_pages,monitorMovieElements.fetched=!0,scrollGate=!1,t}).then(function(e){addMovieElements(e)}).then(function(){1==monitorMovieElements.current_page&&(console.log("PRE-FETCHING"),calcWindowPosition())}).catch(function(t){console.log("---------------------------------"),console.log("Failed somewhere at => loadMovies"),console.log(t),console.log(resp),console.log(e),console.log("---------------------------------")})}function addMovieIndex(e){console.log("=============="),console.log(e),console.log("==============");for(var t=e,r=0;r<e.length;r++)t[r].DOMindex=r;return t}function findMovieIndex(e){for(var t=0;t<moviesOnSite.length;t++)if(moviesOnSite[t].id==e)return t;throw new Error("Couldnt find following ID - returning index number instead")}function mergeNestedArrays(e){var t=[];for(var r in e)for(var n in e[r].results)t.push(e[r].results[n]);return t}function addMovieElements(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=document.createDocumentFragment(),r=0;r<e.length;r++){var n=document.createElement("li");n.className="mg-movie-item";var o=document.createElement("div");o.className="mg-movie-image",o.setAttribute("style","background-image: url('"+(urlImageBase+e[r].poster_path)+"')");var i=document.createElement("h3");i.className="mg-movie-title",i.innerText=""+e[r].title;var a=document.createElement("h4");a.className="mg-movie-year",a.innerText=""+parseFloat(e[r].release_date),n.appendChild(o),n.appendChild(i),n.appendChild(a),t.appendChild(n)}mgMovieContainer.appendChild(t)}function clearMovieElements(){mgMovieContainer.innerHTML=""}function resetMonitor(){monitorMovieElements={total_pages:0,current_page:0,fetched:!1}}function calcWindowPosition(e){if(mainGalleryActive=mainGallery.getAttribute("data-active"),!scrollGate&&"false"!=mainGalleryActive){windowSize=window.innerHeight,scrollPosition=window.pageYOffset;var t=header.offsetHeight+mainGallery.offsetHeight-windowSize-scrollPosition;console.log(t),Number(t)<450&&(scrollGate=!0,loadController({task:"discover",settings:lastSettings}))}}function openSearchField(e){0==searchField?(e.stopPropagation(),searchField=!0,headerSearchInput.focus(),headerSearch.setAttribute("data-active","true"),movieContainer.style="filter: blur(10px)",DOMbody.addEventListener("click",closeSearchField)):(""!=headerSearchInput.value&&console.log("request data "),searchField=!1,headerSearchInput.blur(),headerSearch.setAttribute("data-active","false"),headerSearchInput.value="",movieContainer.style="filter: blur(0px)",DOMbody.removeEventListener("click",closeSearchField))}function keypressSearchField(e){!searchField||13!=e.keyCode&&27!=e.keyCode||openSearchField()}function closeSearchField(e){"header-search-input"!=e.target.id&&openSearchField()}function fetchTMDb(e){function t(e,t){return fetch(e).then(function(e){return handleErrors(e,t)}).then(function(e){return e.json()}).then(function(e){return console.log(e),e}).catch(function(e){return console.log("TMDb data fetch failed")})}var r="c6aea5536b7de40d0294eb356df3c3df",n="&include_adult=false";return"multisearch"==e.task?(console.log("TASK = MULTISEARCH"),t("https://api.themoviedb.org/3/search/multi?api_key="+r+"&language=en-US"+n+"&query="+e.query+"&page="+e.pageNr,e.task)):"genre"==e.task?(console.log("TASK = GENRE"),t("https://api.themoviedb.org/3/discover/movie?api_key="+r+"&with_genres="+genreID+"&primary_release_date.gte=2015-01-01&vote_count.gte=10&page="+pageNr+"&include_video&popularity.desc",e.task)):"actor"==e.task?(console.log("TASK = ACTOR"),t("https://api.themoviedb.org/3/person/"+e.personID+"?api_key="+r+"&language=en-US",e.task)):"actorcredits"==e.task?(console.log("TASK = ACTOR CREDITS"),t("https://api.themoviedb.org/3/person/"+e.personID+"/movie_credits?api_key="+r+"&language=en-US",e.task)):"discover"==e.task?(console.log("TASK = DISCOVER"),monitorMovieElements.current_page+=1,t("https://api.themoviedb.org/3/discover/movie?api_key="+r+n+"&include_video=false"+assembleSettings(e.settings)+"&page="+monitorMovieElements.current_page,e.task)):void 0}function handleErrors(e,t){return e.ok||(console.log(e),console.log(t+"      <=========== following task failed")),e}function assembleSettings(e){return"&"+("with_genres="+getGenreID(e.filtering.genre))+"&"+("vote_average.gte="+e.filtering.rating[0])+"&"+("vote_average.lte="+e.filtering.rating[1])+"&"+("with_runtime.gte="+e.filtering.runtime[0])+"&"+("with_runtime.lte="+e.filtering.runtime[1])+"&"+("primary_release_date.gte="+e.filtering.year[0]+"-01-01")+"&"+("primary_release_date.lte="+e.filtering.year[1]+"-01-01")}function getGenreID(e){for(var t="",r=0;r<e.length;r++)0!=r&&(t+=","),t+=genreList[e[r]];return t}var mgArranger=document.getElementById("mg-arranger-container"),mgToggle=document.getElementById("mg-toggle"),mgRefresh=document.getElementById("mg-refresh");mgToggle.addEventListener("click",toggleArranger),mgRefresh.addEventListener("click",compareArranger);var lastSettings=[],mgFilteringGenre=document.getElementsByClassName("mg-checkbox"),mgRadioInput=document.getElementsByClassName("mg-radio-input"),mgSortingOrder=document.getElementsByClassName("mg-sorting-order"),monitorMovieElements={total_pages:0,current_page:0,fetched:!1},movieAPI=function(){var e=[];return{clearMovies:function(t){e=[]},setMovie:function(t){t.map(function(t){return e.push(t)})},setMovieArr:function(t){e=t},setMovieIndex:function(){e=addMovieIndex(e)},getMovie:function(t){return e[t]},getID:function(t){return e[t].id},getMovieArr:function(){return JSON.parse(JSON.stringify(e))},getIndex:function(e){findMovieIndex(e)}}}(),urlImageBase="http://image.tmdb.org/t/p/w154",mgMovieContainer=document.getElementById("mg-movie-container");window.addEventListener("scroll",calcWindowPosition);var scrollGate=!1,mainGallery=document.getElementById("main-gallery"),header=document.getElementById("header"),windowSize=void 0,scrollPosition=void 0,mainGalleryActive=void 0;window.onload=function(){window.lastSettings=getArrangerSettings(),loadController({task:"discover",settings:lastSettings})};var DOMbody=document.getElementsByTagName("body")[0],headerSearchLogo=document.getElementById("header-search-logo"),headerSearchInput=document.getElementById("header-search-input"),headerSearch=document.getElementById("header-search"),movieContainer=document.getElementById("mg-movie-container"),searchField=!1;headerSearchLogo.addEventListener("click",openSearchField),headerSearchInput.addEventListener("keydown",keypressSearchField),function(){function e(e){if("click"==e.type||13==e.keyCode)return t(r.value),void(r.value="")}function t(e){console.log(e)}var r=document.getElementById("mhs-input"),n=document.getElementById("mhs-search");r.addEventListener("keyup",e),n.addEventListener("click",e)}();var genreList={action:28,adventure:12,animation:16,comedy:35,crime:80,documentary:99,drama:18,fantasy:14,history:36,horror:27,mystery:9648,romance:10749,scifi:878,thriller:53,war:10752,western:37},sliderRating=document.getElementById("mg-slider-rating"),sliderRuntime=document.getElementById("mg-slider-runtime"),sliderYear=document.getElementById("mg-slider-year");noUiSlider.create(sliderRating,{start:[6,10],connect:!0,tooltips:[wNumb({decimals:1}),wNumb({decimals:1})],range:{min:[1],max:[10]}}),noUiSlider.create(sliderRuntime,{start:[80,150],connect:!0,animationDuration:300,tooltips:[wNumb({decimals:0}),wNumb({decimals:0})],range:{min:[60],max:[300]}}),noUiSlider.create(sliderYear,{start:[1990,2017],connect:!0,orientation:"vertical",tooltips:[wNumb({decimals:0}),wNumb({decimals:0})],range:{min:[1940],"50%":[2e3],max:[2020]}});