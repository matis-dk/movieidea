"use strict";function controllerActors(e){fetchTMDb({task:"actor",personID:e}).then(function(e){mainActorsProfile.setAttribute("style","background-image:url('http://image.tmdb.org/t/p/w185"+e.profile_path+"')"),madName.textContent=e.name,madBiography.textContent=e.biography,madFrom.textContent=e.place_of_birth,madBirthday.textContent=e.birthday,madHomepage.textContent=e.homepage,addMostPopular(e.combined_credits.cast),assembelFilmography(sortMovieByYear(e.combined_credits.cast))})}function addMostPopular(e){e=sortMovieByRating(e);for(var t=0;t<8;t++){madActorsTrademark[t].setAttribute("style","background-image:url('http://image.tmdb.org/t/p/w185"+e[t].poster_path+"')"),madActorsTrademark[t].setAttribute("movie-id",""+e[t].id);var r=e[t].title+" ("+parseFloat(e[t].release_date)+")";madActorsTrademark[t].children[0].textContent=r}}function sortMovieByRating(e){return e.sort(function(e,t){return"tv"==e.media_type?0:t.vote_average-e.vote_average}),e}function sortMovieByYear(e){var t=[];return e.map(function(e){e.release_date&&"movie"==e.media_type&&t.push(e)}),t.sort(function(e,t){return parseFloat(t.release_date)-parseFloat(e.release_date)}),console.log(t),t}function assembelFilmography(e){var t=document.createDocumentFragment(),r=0,o=0;madTimeline.innerHTML="";for(var n=0;n<e.length;n++)0==n&&t.appendChild(addFilmographyStart()),(o=parseFloat(e[n].release_date))!=r&&(r=o,t.appendChild(addFilmographyYear(o))),t.appendChild(addFilmographyContent(e[n].title));madTimeline.appendChild(t)}function addFilmographyStart(){var e=document.createElement("li"),t=document.createElement("i");return e.className="mad-start",t.className="fa fa-arrow-circle-o-up",t.setAttribute("aria-hidden","true"),e.appendChild(t),e}function addFilmographyYear(e){var t=document.createElement("li");return t.className="mad-year",t.textContent=e,t}function addFilmographyContent(e){var t=document.createElement("li");return t.className="mad-content",t.textContent=e,t}function addFilmographyEmpty(){var e=document.createElement("li");return e.className="mad-empty",e.className="mad-start",e}function addFilmographyEnd(){var e=document.createElement("li"),t=document.createElement("i");return e.className="mad-end",t.className="fa fa-stop-circle",t.setAttribute("aria-hidden","true"),e.appendChild(t),e}function toggleArranger(e){"false"!=mgArranger.getAttribute("data-open")?mgArranger.setAttribute("data-open","false"):mgArranger.setAttribute("data-open","true")}function getArrangerSettings(){return{filtering:{genre:getArrangerCheckbox(),rating:sliderRating.noUiSlider.get(),runtime:parseData(sliderRuntime.noUiSlider.get()),year:parseData(sliderYear.noUiSlider.get())},sorting:{sortingby:getArrangerRadiobuttons(),sortingorder:getArrangerSortingorder()}}}function parseData(e){var t=[];for(var r in e)t.push(parseInt(e[r]));return t}function getArrangerCheckbox(){for(var e=[],t=0;t<mgFilteringGenre.length;t++)1==mgFilteringGenre[t].checked&&e.push(mgFilteringGenre[t].value);return e}function getArrangerRadiobuttons(){for(var e=0;e<mgRadioInput.length;e++)if(1==mgRadioInput[e].checked)return mgRadioInput[e].value}function getArrangerSortingorder(){return mgSortingOrder[0].checked?mgSortingOrder[0].value:mgSortingOrder[1].value}function compareArranger(){var e=getArrangerSettings();if(compareSettings(e,"filtering")){console.log("--------------------------------------------"),console.log("UPDATE DOM - with new filter"),window.lastSettings=e;var t={task:"discover",settings:lastSettings};return toggleArranger(),void loadController(t,"reset-movies")}if(compareSettings(e,"sorting")){console.log("UPDATE DOM - with new positioning"),window.lastSettings=e,toggleArranger();var r=sortingMovies(e.sorting.sortingby,e.sorting.sortingorder);return clearMovieElements(),addMovieElements(r),void movieAPI.setMovieArr(r)}console.log("No changes found"),toggleArranger()}function compareSettings(e,t){return JSON.stringify(lastSettings[t])!==JSON.stringify(e[t])}function sortingMovies(e,t){function r(e,t,r){var n=void 0;return"word"==e&&(n=o.sort(sortingWords(t,r))),"number"==e&&(n=o.sort(sortingNumbers(t,r))),n}var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:movieAPI.getMovieArr();if(o)return console.log("Sorting by "+e),"rating"==e?r("number","vote_average",t):"popularity"==e?r("number","popularity",t):"year"==e?r("number","release_date",t):"title"==e?r("word","title",t):void 0}function sortingNumbers(e,t){return function(r,o){return"lowest"==t?parseFloat(r[e])-parseFloat(o[e]):"highest"==t?parseFloat(o[e])-parseFloat(r[e]):void 0}}function sortingWords(e,t){return function(r,o){var n=r[e].toUpperCase(),i=o[e].toUpperCase();if("lowest"==t){if(n<i)return-1;if(n>i)return 1}if("highest"==t){if(n>i)return-1;if(n<i)return 1}return 0}}function loadMovies(e){return console.log("Loading movies"),Promise.resolve(fetchTMDb(e))}function loadController(e,t){"reset-movies"==t&&(console.log("Resetting movies!"),movieAPI.clearMovies(),clearMovieElements(),resetMonitor()),monitorMovieElements.total_pages==monitorMovieElements.current_page&&monitorMovieElements.fetched?console.log("All movies loaded!"):loadMovies(e).then(function(e){var t=sortingMovies(lastSettings.sorting.sortingby,lastSettings.sorting.sortingorder,e.results);return movieAPI.setMovie(t),movieAPI.setMovieIndex(),monitorMovieElements.total_pages=e.total_pages,monitorMovieElements.fetched=!0,scrollGate=!1,t}).then(function(e){addMovieElements(e)}).then(function(){1==monitorMovieElements.current_page&&(console.log("PRE-FETCHING"),calcWindowPosition())}).catch(function(t){console.log("---------------------------------"),console.log("Failed somewhere at => loadMovies"),console.log(t),console.log(resp),console.log(e),console.log("---------------------------------")})}function addMovieIndex(e){console.log("=============="),console.log(e),console.log("==============");for(var t=e,r=0;r<e.length;r++)t[r].DOMindex=r;return t}function findMovieIndex(e,t){for(var r=0;r<t.length;r++)if(t[r].id==e)return r;throw new Error("Couldnt find following ID - returning index number instead")}function mergeNestedArrays(e){var t=[];for(var r in e)for(var o in e[r].results)t.push(e[r].results[o]);return t}function addMovieElements(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=document.createDocumentFragment(),r=0;r<e.length;r++){var o=document.createElement("li");o.className="mg-movie-item",o.setAttribute("movie-id",""+e[r].id);var n=document.createElement("div");n.className="mg-movie-image",n.setAttribute("style","background-image: url('"+(urlImageBase+e[r].poster_path)+"')");var i=document.createElement("h3");i.className="mg-movie-title",i.innerText=""+e[r].title;var a=document.createElement("h4");a.className="mg-movie-year",a.innerText=""+parseFloat(e[r].release_date),o.appendChild(n),o.appendChild(i),o.appendChild(a),t.appendChild(o)}mgMovieContainer.appendChild(t)}function clearMovieElements(){mgMovieContainer.innerHTML=""}function resetMonitor(){monitorMovieElements={total_pages:0,current_page:0,fetched:!1}}function mouseFilter(e){if(e.target.parentNode.classList.contains("mg-movie-item")){if(updateMovieSeletion(e.target.parentNode),"click"==e.type)return void console.log("click");if("dblclick"==e.type){console.log("dblclick");var t=e.target.parentNode.getAttribute("movie-id");return void controllerMovieOverlay("open",movieAPI.getMovieById(t))}}}function updateMovieSeletion(e){var t=document.querySelector('.mg-movie-item[movie-id="'+movieSelection.current+'"]');null!==t&&t.removeAttribute("movie-selected"),e.setAttribute("movie-selected","true"),movieSelection.current=e.getAttribute("movie-id")}function calcMovieSelection(e){function t(e,t){updateMovieSeletion(document.querySelector(".mg-movie-item:nth-child("+(e+1)+")"));var r=document.getElementById("footer-key-"+t);r.setAttribute("style","background-color: #1abc9c"),setTimeout(function(){r.removeAttribute("style")},300)}var r=currentDomPosition(movieSelection.current),o=moviesPrRow();if("37"==e){if(0==r)return;return r%o==0&&pageScroll("up"),r-=1,void t(r,e)}if("38"==e){if(o>r)return;return r-=o,pageScroll("up"),void t(r,e)}if("39"==e){if(r==movieAPI.getMovieArr().length-1)return;return(r+=1)%o==0&&pageScroll("down"),void t(r,e)}if("40"==e){if(r+o>movieAPI.getMovieArr().length-1)return;return r+=o,pageScroll("down"),void t(r,e)}}function pageScroll(e){var t=document.scrollingElement;if("down"==e&&downActive)var r=0,o=setInterval(function(){r>=35||t.scrollTop==t.scrollHeight?(clearInterval(o),downActive=!0):(downActive=!1,r++,t.scrollTop+=10)},5);if("up"==e&&upActive)var n=0,i=setInterval(function(){n>=35||0==t.scrollTop?(clearInterval(i),upActive=!0):(upActive=!1,n++,t.scrollTop-=10)},5)}function moviesPrRow(){var e=document.querySelector(".mg-movie-item").offsetWidth+20,t=mgMovieContainer.offsetWidth;return Math.floor(t/e)}function currentDomPosition(e){for(var t=0;mgMovieContainer.children[t];){if(mgMovieContainer.children[t].getAttribute("movie-id")===e)return t;t++}}function calcWindowPosition(e){if(mainGalleryActive=mainGallery.getAttribute("data-active"),!scrollGate&&"false"!=mainGalleryActive){windowSize=window.innerHeight,scrollPosition=window.pageYOffset;var t=header.offsetHeight+mainGallery.offsetHeight-windowSize-scrollPosition;console.log(t),Number(t)<450&&(scrollGate=!0,loadController({task:"discover",settings:lastSettings}))}}function mainSectionController(e,t){for(var r in main)"true"==main[r].getAttribute("data-active")&&main[r].setAttribute("data-active","false");e.setAttribute("data-active","true"),"main-actors"==e.id&&controllerActors(t)}function controllerMovieOverlay(e,t){if("open"==e){var r={task:"movie",movieID:t.id};Promise.resolve(fetchTMDb(r)).then(function(e){return updateMovieOverlay(e)}),omPoster.setAttribute("style",'background-image: url("http://image.tmdb.org/t/p/w342'+t.poster_path+'")'),omPosterInner.setAttribute("style",'background-image: url("http://image.tmdb.org/t/p/w342'+t.poster_path+'")'),overlayMovies.setAttribute("data-active","true"),overlayMovies.addEventListener("click",toggleOverlay),overlayMovieCon.addEventListener("click",toggleOverlayCon)}"close"==e&&(overlayMovies.setAttribute("data-active","false"),overlayMovies.removeEventListener("click",toggleOverlay),overlayMovieCon.removeEventListener("click",toggleOverlayCon))}function toggleOverlay(){controllerMovieOverlay("close")}function toggleOverlayCon(e){e.stopPropagation(),e.target.hasAttribute("data-actor-id")&&(controllerMovieOverlay("close"),mainSectionController(mainActors,e.target.getAttribute("data-actor-id")),console.log("calling actor page")),e.target.hasAttribute("data-genre-id")}function updateMovieOverlay(e){omTitle.textContent=e.title+"  - "+e.tagline,omYear.textContent=parseFloat(e.release_date),omDuration.textContent=e.runtime,omRating.textContent=e.vote_average,omVotes.textContent=e.vote_count+" votes",omDirector.textContent=getIdentity(e.credits.crew,"Director"),omWriter.textContent=getIdentity(e.credits.crew,"Writer","Screenplay"),omReleasedate.textContent=e.release_date,omDescription.textContent=e.overview,addInnerElements(e.credits.cast,6,"actor",omActors),addInnerElements(e.genres,!1,"genre",omGenre),addCastPictures(e.credits.cast)}function addCastPictures(e){for(var t in omActorsIcon)omActorsIcon[t].setAttribute("style","background-image: url('http://image.tmdb.org/t/p/w45"+e[t].profile_path+"')")}function addInnerElements(e,t,r,o){var n=document.createDocumentFragment();t||(t=e.length);for(var i=0;i<t;i++){var a=document.createElement("span");a.className="om-inner-element",a.setAttribute("data-"+r+"-id",""+e[i].id),a.textContent=""+e[i].name,n.appendChild(a)}o.textContent="",o.appendChild(n)}function getIdentity(e,t,r){for(var o in e)if(e[o].job==t||e[o].job==r)return e[o].name}function openSearchField(e){0==searchField?(e.stopPropagation(),searchField=!0,headerSearchInput.focus(),headerSearch.setAttribute("data-active","true"),movieContainer.style="filter: blur(10px)",DOMbody.addEventListener("click",closeSearchField)):(""!=headerSearchInput.value&&console.log("request data "),searchField=!1,headerSearchInput.blur(),headerSearch.setAttribute("data-active","false"),headerSearchInput.value="",movieContainer.style="filter: blur(0px)",DOMbody.removeEventListener("click",closeSearchField))}function keypressSearchField(e){!searchField||13!=e.keyCode&&27!=e.keyCode||openSearchField()}function closeSearchField(e){"header-search-input"!=e.target.id&&openSearchField()}function fetchTMDb(e){function t(e,t){return fetch(e).then(function(e){return handleErrors(e,t)}).then(function(e){return e.json()}).then(function(e){return console.log(e),e}).catch(function(e){return console.log("TMDb data fetch failed")})}var r="c6aea5536b7de40d0294eb356df3c3df",o="&include_adult=false";return"movie"==e.task?(console.log("TASK = MOVIE"),t("https://api.themoviedb.org/3/movie/"+e.movieID+"?api_key="+r+"&append_to_response=credits",e.task)):"multisearch"==e.task?(console.log("TASK = MULTISEARCH"),t("https://api.themoviedb.org/3/search/multi?api_key="+r+"&language=en-US"+o+"&query="+e.query+"&page="+e.pageNr,e.task)):"genre"==e.task?(console.log("TASK = GENRE"),t("https://api.themoviedb.org/3/discover/movie?api_key="+r+"&with_genres="+genreID+"&primary_release_date.gte=2015-01-01&vote_count.gte=10&page="+pageNr+"&include_video&popularity.desc",e.task)):"actor"==e.task?(console.log("TASK = ACTOR"),t("https://api.themoviedb.org/3/person/"+e.personID+"?api_key="+r+"&language=en-US&append_to_response=combined_credits",e.task)):"discover"==e.task?(console.log("TASK = DISCOVER"),monitorMovieElements.current_page+=1,t("https://api.themoviedb.org/3/discover/movie?api_key="+r+o+"&include_video=false"+assembleSettings(e.settings)+"&page="+monitorMovieElements.current_page,e.task)):void 0}function handleErrors(e,t){return e.ok||(console.log(e),console.log(t+"      <=========== following task failed")),e}function assembleSettings(e){return"&"+("with_genres="+getGenreID(e.filtering.genre))+"&"+("vote_average.gte="+e.filtering.rating[0])+"&"+("vote_average.lte="+e.filtering.rating[1])+"&"+("with_runtime.gte="+e.filtering.runtime[0])+"&"+("with_runtime.lte="+e.filtering.runtime[1])+"&"+("primary_release_date.gte="+e.filtering.year[0]+"-01-01")+"&"+("primary_release_date.lte="+e.filtering.year[1]+"-01-01")}function getGenreID(e){for(var t="",r=0;r<e.length;r++)0!=r&&(t+=","),t+=genreList[e[r]];return t}var mainActorsProfile=document.getElementById("main-actors-profile"),madName=document.getElementById("mad-name"),madBiography=document.getElementById("mad-biography"),madFrom=document.getElementById("mad-from"),madBirthday=document.getElementById("mad-birthday"),madHomepage=document.getElementById("mad-homepage"),madTimeline=document.getElementById("mad-timeline"),madActorsTrademark=Array.from(document.getElementById("mat-container").children),mgArranger=document.getElementById("mg-arranger-container"),mgToggle=document.getElementById("mg-toggle"),mgRefresh=document.getElementById("mg-refresh");mgToggle.addEventListener("click",toggleArranger),mgRefresh.addEventListener("click",compareArranger);var lastSettings=[],mgFilteringGenre=document.getElementsByClassName("mg-checkbox"),mgRadioInput=document.getElementsByClassName("mg-radio-input"),mgSortingOrder=document.getElementsByClassName("mg-sorting-order"),monitorMovieElements={total_pages:0,current_page:0,fetched:!1},movieAPI=function(){var e=[];return{clearMovies:function(t){e=[]},setMovie:function(t){t.map(function(t){return e.push(t)})},setMovieArr:function(t){e=JSON.parse(JSON.stringify(t))},setMovieIndex:function(){e=addMovieIndex(e)},getMovie:function(t){return e[t]},getMovieArr:function(){return JSON.parse(JSON.stringify(e))},getMovieById:function(t){return e[findMovieIndex(t,e)]}}}(),urlImageBase="http://image.tmdb.org/t/p/w154",mgMovieContainer=document.getElementById("mg-movie-container"),keyboardStateActive=!1;mgMovieContainer.addEventListener("dblclick",mouseFilter),mgMovieContainer.addEventListener("click",mouseFilter),mgMovieContainer.addEventListener("keyup",function(){keyboardStateActive=!1}),mgMovieContainer.addEventListener("keydown",function(e){if(keyboardStateActive)return e.preventDefault(),void console.log("keyboard event cancelled");keyboardStateActive=!0,"37"!=e.keyCode&&"38"!=e.keyCode&&"39"!=e.keyCode&&"40"!=e.keyCode&&"13"!=e.keyCode||(e.preventDefault(),calcMovieSelection(e.keyCode))});var movieSelection={current:291805},main=document.getElementById("main"),upActive=!0,downActive=!0;window.addEventListener("scroll",calcWindowPosition);var scrollGate=!1,header=document.getElementById("header"),windowSize=void 0,scrollPosition=void 0,mainGalleryActive=void 0;window.onload=function(){window.lastSettings=getArrangerSettings(),loadController({task:"discover",settings:lastSettings})};var main=Array.from(document.getElementById("main").children),mainHome=document.getElementById("main-home"),mainWall=document.getElementById("main-wall"),mainActors=document.getElementById("main-actors"),mainGenres=document.getElementById("main-genre"),mainGallery=document.getElementById("main-gallery"),omPoster=document.getElementById("om-poster"),omPosterInner=document.getElementById("om-poster-inner"),omTitle=document.getElementById("om-title"),omYear=document.getElementById("om-year"),omDuration=document.getElementById("om-duration"),omRating=document.getElementById("om-rating"),omVotes=document.getElementById("om-votes"),omDirector=document.getElementById("om-director"),omGenre=document.getElementById("om-genre"),omWriter=document.getElementById("om-writer"),omReleasedate=document.getElementById("om-releasedate"),omActors=document.getElementById("om-actors"),omDescription=document.getElementById("om-description"),omActorsIcon=Array.from(document.getElementById("om-actors-icon").children),overlayMovies=document.getElementById("overlay-movies"),overlayMovieCon=document.getElementById("overlay-movies-container"),DOMbody=document.getElementsByTagName("body")[0],headerSearchLogo=document.getElementById("header-search-logo"),headerSearchInput=document.getElementById("header-search-input"),headerSearch=document.getElementById("header-search"),movieContainer=document.getElementById("mg-movie-container"),searchField=!1;headerSearchLogo.addEventListener("click",openSearchField),headerSearchInput.addEventListener("keydown",keypressSearchField),function(){function e(e){if("click"==e.type||13==e.keyCode)return t(r.value),void(r.value="")}function t(e){console.log(e)}var r=document.getElementById("mhs-input"),o=document.getElementById("mhs-search");r.addEventListener("keyup",e),o.addEventListener("click",e)}();var genreList={action:28,adventure:12,animation:16,comedy:35,crime:80,documentary:99,drama:18,fantasy:14,history:36,horror:27,mystery:9648,romance:10749,scifi:878,thriller:53,war:10752,western:37},sliderRating=document.getElementById("mg-slider-rating"),sliderRuntime=document.getElementById("mg-slider-runtime"),sliderYear=document.getElementById("mg-slider-year");noUiSlider.create(sliderRating,{start:[6,10],connect:!0,tooltips:[wNumb({decimals:1}),wNumb({decimals:1})],range:{min:[1],max:[10]}}),noUiSlider.create(sliderRuntime,{start:[80,150],connect:!0,animationDuration:300,tooltips:[wNumb({decimals:0}),wNumb({decimals:0})],range:{min:[60],max:[300]}}),noUiSlider.create(sliderYear,{start:[1990,2017],connect:!0,orientation:"vertical",tooltips:[wNumb({decimals:0}),wNumb({decimals:0})],range:{min:[1940],"50%":[2e3],max:[2020]}});