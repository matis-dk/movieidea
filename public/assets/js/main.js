"use strict";function openSearchField(e){0==searchField?(e.stopPropagation(),searchField=!0,headerSearchInput.focus(),headerSearch.setAttribute("data-active","true"),movieContainer.style="filter: blur(10px)",DOMbody.addEventListener("click",closeSearchField)):(""!=headerSearchInput.value&&console.log("request data "),searchField=!1,headerSearchInput.blur(),headerSearch.setAttribute("data-active","false"),headerSearchInput.value="",movieContainer.style="filter: blur(0px)",DOMbody.removeEventListener("click",closeSearchField))}function keypressSearchField(e){!searchField||13!=e.keyCode&&27!=e.keyCode||openSearchField()}function closeSearchField(e){"header-search-input"!=e.target.id&&openSearchField()}function toggleArranger(e){"false"!=mgArranger.getAttribute("data-open")?mgArranger.setAttribute("data-open","false"):mgArranger.setAttribute("data-open","true")}function getArrangerSettings(){return{filtering:{genre:getArrangerCheckbox(),rating:sliderRating.noUiSlider.get(),runtime:parseData(sliderRuntime.noUiSlider.get()),year:parseData(sliderYear.noUiSlider.get())},sorting:{sortingby:getArrangerRadiobuttons(),sortingorder:getArrangerSortingorder()}}}function parseData(e){var t=[];for(var r in e)t.push(parseInt(e[r]));return t}function getArrangerCheckbox(){for(var e=[],t=0;t<mgFilteringGenre.length;t++)1==mgFilteringGenre[t].checked&&e.push(mgFilteringGenre[t].value);return e}function getArrangerRadiobuttons(){for(var e=0;e<mgRadioInput.length;e++)if(1==mgRadioInput[e].checked)return mgRadioInput[e].value}function getArrangerSortingorder(){return mgSortingOrder[0].checked?mgSortingOrder[0].value:mgSortingOrder[1].value}function compareArranger(){function e(e,t){return JSON.stringify(lastSettings[t])!==JSON.stringify(e[t])}var t=getArrangerSettings();if(e(t,"filtering")){console.log("UPDATE DOM - with new filter");var r={task:"discover",loadState:"loadStart",settings:t};return toggleArranger(),window.lastSettings=t,void loadController(r,"reset-movies")}if(e(t,"sorting"))return console.log("UPDATE DOM - with new positioning"),toggleArranger(),void(window.lastSettings=t);console.log("No changes found"),toggleArranger()}function setLastSettings(){window.lastSettings=getArrangerSettings()}function loadMovies(e){return"loadStart"==e.loadState?(console.log("Loading start movies"),Promise.all([fetchTMDb(e),fetchTMDb(e),fetchTMDb(e)]).then(function(e){return monitorMovieElements.total_pages=e[0].total_pages,monitorMovieElements.fetched=!0,e}).then(function(e){return mergeNestedArrays(e)}).then(function(e){return movieAPI.setMovieArr(e),e})):"loadMore"==e.loadState?(console.log("Loading more movies"),Promise.all([fetchTMDb(e)]).then(function(e){return movieAPI.setMovie(e[0].results),e[0].results})):void 0}function loadController(e,t){if(monitorMovieElements.total_pages!=monitorMovieElements.current_page||!monitorMovieElements.fetched)return"reset-movies"==t?(clearMovieElements(),resetMonitor(),void loadMovies(e).then(function(e){return addMovieElements(e)}).catch(function(e){console.log(e),console.log("Failed somewhere at => loadMovies")})):void("load-movies"!=t||loadMovies(e).then(function(e){return addMovieElements(e)}).then(function(e){return scrollGate=!1}).catch(function(e){console.log(e),console.log("Failed somewhere at => loadMovies")}));console.log("All movies loaded!")}function mergeNestedArrays(e){var t=[];for(var r in e)for(var n in e[r].results)t.push(e[r].results[n]);return t}function addMovieElements(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=document.getElementById("mg-movie-container"),r=document.createDocumentFragment(),n=0;n<e.length;n++){var o=document.createElement("li");o.className="mg-movie-item";var i=document.createElement("div");i.className="mg-movie-image",i.setAttribute("style","background-image: url('"+(urlImageBase+e[n].poster_path)+"')");var a=document.createElement("h3");a.className="mg-movie-title",a.innerText=""+e[n].original_title;var l=document.createElement("h4");l.className="mg-movie-year",l.innerText=""+parseFloat(e[n].release_date),o.appendChild(i),o.appendChild(a),o.appendChild(l),r.appendChild(o)}t.appendChild(r)}function clearMovieElements(){document.getElementById("mg-movie-container").innerHTML=""}function resetMonitor(){monitorMovieElements={total_pages:0,current_page:0,fetched:!1}}function calcWindowPosition(e){if(!scrollGate){windowSize=window.innerHeight,scrollPosition=window.pageYOffset;var t=header.offsetHeight+mainGallery.offsetHeight-windowSize-scrollPosition;console.log(t),Number(t)<350&&(console.log(),scrollGate=!0,loadController({task:"discover",loadState:"loadMore",settings:lastSettings},"load-movies"))}}function fetchTMDb(e){function t(e,t){return fetch(e).then(function(e){return handleErrors(e,t)}).then(function(e){return e.json()}).then(function(e){return console.log(e),e}).catch(function(e){return console.log("TMDb data fetch failed")})}var r="c6aea5536b7de40d0294eb356df3c3df",n="&include_adult=false";return"multisearch"==e.task?(console.log("TASK = MULTISEARCH"),t("https://api.themoviedb.org/3/search/multi?api_key="+r+"&language=en-US"+n+"&query="+e.query+"&page="+e.pageNr,e.task)):"genre"==e.task?(console.log("TASK = GENRE"),t("https://api.themoviedb.org/3/discover/movie?api_key="+r+"&with_genres="+genreID+"&primary_release_date.gte=2015-01-01&vote_count.gte=10&page="+pageNr+"&include_video&popularity.desc",e.task)):"actor"==e.task?(console.log("TASK = ACTOR"),t("https://api.themoviedb.org/3/person/"+e.personID+"?api_key="+r+"&language=en-US",e.task)):"actorcredits"==e.task?(console.log("TASK = ACTOR CREDITS"),t("https://api.themoviedb.org/3/person/"+e.personID+"/movie_credits?api_key="+r+"&language=en-US",e.task)):"discover"==e.task?(console.log("TASK = DISCOVER"),monitorMovieElements.current_page+=1,console.log(monitorMovieElements.current_page),t("https://api.themoviedb.org/3/discover/movie?api_key="+r+n+"&include_video=false"+assembleSettings(e.settings)+"&page="+monitorMovieElements.current_page,e.task)):void 0}function handleErrors(e,t){return e.ok||(console.log(e),console.log(t+"      <=========== following task failed")),e}function assembleSettings(e){var t="with_genres="+getGenreID(e.filtering.genre),r="vote_average.gte="+e.filtering.rating[0],n="vote_average.lte="+e.filtering.rating[1],o="with_runtime.gte="+e.filtering.runtime[0],i="with_runtime.lte="+e.filtering.runtime[1],a="primary_release_date.gte="+e.filtering.year[0]+"-01-01",l="&"+t+"&"+r+"&"+n+"&"+o+"&"+i+"&"+a+"&"+("primary_release_date.lte="+e.filtering.year[1]+"-01-01");return console.log(a),l}function getGenreID(e){for(var t="",r=0;r<e.length;r++)0!=r&&(t+=","),t+=genreList[e[r]];return t}var DOMbody=document.getElementsByTagName("body")[0],headerSearchLogo=document.getElementById("header-search-logo"),headerSearchInput=document.getElementById("header-search-input"),headerSearch=document.getElementById("header-search"),movieContainer=document.getElementById("mg-movie-container"),searchField=!1;headerSearchLogo.addEventListener("click",openSearchField),headerSearchInput.addEventListener("keydown",keypressSearchField);var mgArranger=document.getElementById("mg-arranger-container"),mgToggle=document.getElementById("mg-toggle"),mgRefresh=document.getElementById("mg-refresh");mgToggle.addEventListener("click",toggleArranger),mgRefresh.addEventListener("click",compareArranger);var lastSettings=[],mgFilteringGenre=document.getElementsByClassName("mg-checkbox"),mgRadioInput=document.getElementsByClassName("mg-radio-input"),mgSortingOrder=document.getElementsByClassName("mg-sorting-order"),monitorMovieElements={total_pages:0,current_page:0,fetched:!1},movieAPI=function(){var e=[];return{clearMovies:function(t){e=[]},setMovie:function(t){t.map(function(t){return e.push(t)})},setMovieArr:function(t){e=t},getMovie:function(t){return e[t]},getID:function(t){return e[t].id},getMovieArr:function(){return e},getIndex:function(t){for(var r=0;r<e.length;r++)if(e[r].id==t)return r;throw new Error("Couldnt find following ID and thus return index number")}}}(),urlImageBase="http://image.tmdb.org/t/p/w154";window.addEventListener("scroll",calcWindowPosition);var scrollGate=!1,mainGallery=document.getElementById("main-gallery"),header=document.getElementById("header"),windowSize=void 0,scrollPosition=void 0;window.onload=function(){loadController({task:"discover",loadState:"loadMore",settings:getArrangerSettings()})};var sliderRating=document.getElementById("mg-slider-rating"),sliderRuntime=document.getElementById("mg-slider-runtime"),sliderYear=document.getElementById("mg-slider-year");noUiSlider.create(sliderRating,{start:[6,10],connect:!0,tooltips:[wNumb({decimals:1}),wNumb({decimals:1})],range:{min:[1],max:[10]}}),noUiSlider.create(sliderRuntime,{start:[80,150],connect:!0,animationDuration:300,tooltips:[wNumb({decimals:0}),wNumb({decimals:0})],range:{min:[60],max:[300]}}),noUiSlider.create(sliderYear,{start:[1990,2017],connect:!0,orientation:"vertical",tooltips:[wNumb({decimals:0}),wNumb({decimals:0})],range:{min:[1940],"50%":[2e3],max:[2020]}});var genreList={action:28,adventure:12,animation:16,comedy:35,crime:80,documentary:99,drama:18,fantasy:14,history:36,horror:27,mystery:9648,romance:10749,scifi:878,thriller:53,war:10752,western:37};